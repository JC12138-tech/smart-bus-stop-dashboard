<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Smart Bus Stop Dashboard</h1>

  <form method="get">
    <label>Select stop for ETA:</label>
    <select name="stop_id">
      <option value="">-- choose --</option>
      {% for s in stops %}
        <option value="{{ s.stop_id }}" {% if s.stop_id == selected_stop_id %}selected{% endif %}>
          {{ s.stop_id }} - {{ s.name }}
        </option>
      {% endfor %}
    </select>
    <button type="submit">Apply</button>
  </form>
{% if selected_stop_id %}
  <p>
    <a href="/export.xlsx?stop_id={{ selected_stop_id }}">
      Download XLSX export for stop {{ selected_stop_id }}
    </a>
  </p>
{% else %}
  <p>
    <a href="/export.xlsx">
      Download XLSX export (no stop selected)
    </a>
  </p>
{% endif %}

  <h2>Latest Status</h2>
  <ul>
    {% for c in cards %}
      <li>
        <strong>{{ c.bus_id }}</strong>
        | capacity={{ c.capacity }}
        | crowding={{ c.latest_level }}{% if c.latest_occ != None %} (occ={{ c.latest_occ }}){% endif %}
        | ETA(min)={% if c.latest_eta_min != None %}{{ c.latest_eta_min }}{% else %}N/A{% endif %}
      </li>
    {% endfor %}
  </ul>

  <h2>Crowding Trend</h2>
  <canvas id="crowdingChart"></canvas>

  <h2>ETA Trend</h2>
  <canvas id="etaChart"></canvas>

  <script>
    const labels = {{ chart_labels_json|safe }};
    const crowdingSeries = {{ crowding_series_json|safe }};
    const etaSeries = {{ eta_series_json|safe }};

    function makeDatasets(seriesObj) {
      const datasets = [];
      for (const [busId, arr] of Object.entries(seriesObj)) {
        datasets.push({
          label: busId,
          data: arr,
          tension: 0.2,
        });
      }
      return datasets;
    }

    new Chart(document.getElementById("crowdingChart"), {
      type: "line",
      data: { labels, datasets: makeDatasets(crowdingSeries) },
    });

    new Chart(document.getElementById("etaChart"), {
      type: "line",
      data: { labels, datasets: makeDatasets(etaSeries) },
    });
  </script>

  <p><a href="/">Home</a> | <a href="/upload/">Upload</a> | <a href="/admin/">Admin</a></p>
</body>
</html>
